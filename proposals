FROM debian:stable-slim

ADD https://github.com/motoz/PellMon/releases/download/v0.7.0/pellmon_0.7.0-1_all.deb /

ENV TZ=Europe/Copenhagen
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

RUN apt-get update && apt-get install -y \
    rrdtool \
    python-serial \
    python-cherrypy3 \
    python-dbus \
    python-mako \
    python-gobject \
    python-simplejson \
    python-dateutil \
    python-ws4py \
    python-crypto \
    autoconf \
    python-argcomplete \
    python-pip \
    supervisor
RUN dpkg -i /pellmon_0.7.0-1_all.deb
RUN pip install pyownet
RUN pip install xtea
RUN mkdir -p /var/log/supervisor

EXPOSE 8081
VOLUME ["/etc/pellmon", "/var/lib/pellmon"]

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

CMD ["/usr/sbin/dbus-uuidgen > /var/lib/dbus/machine-id"]
CMD ["mkdir -p /var/run/dbus"]
CMD ["/usr/bin/supervisord"]